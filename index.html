<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Truck Manager - Gestionnaire d'Entreprise</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .nav-btn.active {
            background: linear-gradient(45deg, #FF6B6B, #ee5a24);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .content-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .trucks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .truck-card {
            background: linear-gradient(145deg, #f0f0f0, #e6e6e6);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .truck-status {
            padding: 5px 10px;
            border-radius: 15px;
            color: white;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 10px;
        }

        .status-idle { background: #FFA500; }
        .status-working { background: #4CAF50; }
        .status-maintenance { background: #F44336; }

        .mission-card {
            background: linear-gradient(145deg, #e3f2fd, #bbdefb);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .mission-card:hover {
            transform: translateX(5px);
            border-color: #2196F3;
        }

        .mission-reward {
            background: #4CAF50;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin-top: 10px;
        }

        .shop-item {
            background: linear-gradient(145deg, #fff3e0, #ffe0b2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid #ff9800;
        }

        .shop-price {
            background: #FF9800;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin-top: 10px;
        }

        .buy-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            margin-left: 10px;
            transition: all 0.3s ease;
        }

        .buy-btn:hover {
            background: #45a049;
            transform: scale(1.05);
        }

        .buy-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .admin-section {
            background: #f5f5f5;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #ddd;
        }

        .admin-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 5px 0;
        }

        .admin-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            margin-top: 10px;
        }

        .progress-bar {
            background: #e0e0e0;
            border-radius: 10px;
            height: 20px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #4CAF50, #45a049);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transform: translateX(300px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .save-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .save-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .reset-btn {
            background: #F44336;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            .nav-buttons {
                justify-content: center;
            }
            .nav-btn {
                font-size: 12px;
                padding: 10px 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöõ Truck Manager - Gestionnaire d'Entreprise</h1>
            <div class="save-controls">
                <button class="save-btn" onclick="saveGame()">üíæ Sauvegarder</button>
                <button class="save-btn" onclick="exportSave()">üì§ Exporter</button>
                <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importSave(event)">
                <button class="save-btn" onclick="document.getElementById('import-file').click()">üì• Importer</button>
                <button class="save-btn" id="sound-toggle" onclick="toggleSound()">üîä Son ON</button>
                <button class="reset-btn" onclick="resetGame()" style="margin-left: auto;">üîÑ R√©initialiser</button>
            </div>
        </div>

        <div class="nav-buttons">
            <button class="nav-btn active" onclick="showSection('dashboard')">üìä Tableau de Bord</button>
            <button class="nav-btn" onclick="showSection('trucks')">üöõ Mes Camions</button>
            <button class="nav-btn" onclick="showSection('missions')">üìã Missions</button>
            <button class="nav-btn" onclick="showSection('shop')">üõí Boutique</button>
            <button class="nav-btn" onclick="showSection('factory')">üè≠ Usine</button>
            <button class="nav-btn" onclick="showSection('admin')">‚öôÔ∏è Admin</button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="money">0</div>
                <div class="stat-label">üí∞ Argent</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="fuel">10</div>
                <div class="stat-label">‚õΩ Carburant (L)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="truck-count">1</div>
                <div class="stat-label">üöõ Camions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="reputation">100</div>
                <div class="stat-label">‚≠ê R√©putation</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="offline-time">0m</div>
                <div class="stat-label">‚è∞ Temps hors ligne</div>
            </div>
        </div>

        <div id="dashboard" class="content-section active">
            <h2>üìä Tableau de Bord</h2>
            
            <!-- Livraisons en cours -->
            <div id="active-missions-section" style="margin-bottom: 20px;">
                <h3>üöõ Livraisons en Cours</h3>
                <div id="active-missions-container"></div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Production d'essence</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="fuel-progress" style="width: 0%">0%</div>
                    </div>
                    <p>Prochaine production dans <span id="fuel-timer">60s</span></p>
                </div>
                <div class="stat-card">
                    <h3>Revenus Total</h3>
                    <div class="stat-value" id="total-earnings">0</div>
                    <div class="stat-label">Depuis le d√©but</div>
                </div>
                <div class="stat-card">
                    <h3>Missions Termin√©es</h3>
                    <div class="stat-value" id="completed-missions">0</div>
                    <div class="stat-label">Au total</div>
                </div>
            </div>
        </div>

        <div id="trucks" class="content-section">
            <h2>üöõ Mes Camions</h2>
            <div class="trucks-grid" id="trucks-container"></div>
        </div>

        <div id="missions" class="content-section">
            <h2>üìã Missions Disponibles</h2>
            <div id="missions-container"></div>
        </div>

        <div id="shop" class="content-section">
            <h2>üõí Boutique</h2>
            <div id="shop-container"></div>
        </div>

        <div id="factory" class="content-section">
            <h2>üè≠ Usine √† Carburant</h2>
            <div class="stat-card">
                <h3>Production Actuelle</h3>
                <p>Niveau: <span id="factory-level">1</span></p>
                <p>Production: <span id="factory-rate">1</span> L/heure</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="factory-progress" style="width: 0%">0%</div>
                </div>
            </div>
            <div class="shop-item">
                <h3>Am√©liorer l'Usine</h3>
                <p>Augmente la production de carburant de 1 L/heure</p>
                <span class="shop-price" id="factory-upgrade-cost">500‚Ç¨</span>
                <button class="buy-btn" onclick="upgradeFactory()">Am√©liorer</button>
            </div>
        </div>

        <div id="admin" class="content-section">
            <h2>‚öôÔ∏è Panneau d'Administration</h2>
            <div class="admin-grid">
                <div class="admin-section">
                    <h3>üí∞ Gestion de l'Argent</h3>
                    <input type="number" class="admin-input" id="admin-money" placeholder="Montant">
                    <button class="admin-btn" onclick="setMoney()">D√©finir l'Argent</button>
                    <button class="admin-btn" onclick="addMoney()">Ajouter l'Argent</button>
                </div>
                <div class="admin-section">
                    <h3>‚õΩ Gestion du Carburant</h3>
                    <input type="number" class="admin-input" id="admin-fuel" placeholder="Quantit√©">
                    <button class="admin-btn" onclick="setFuel()">D√©finir le Carburant</button>
                    <button class="admin-btn" onclick="addFuel()">Ajouter du Carburant</button>
                </div>
                <div class="admin-section">
                    <h3>üöõ Gestion des Camions</h3>
                    <button class="admin-btn" onclick="addTruck()">Ajouter un Camion</button>
                    <button class="admin-btn" onclick="repairAllTrucks()">R√©parer Tous les Camions</button>
                </div>
                <div class="admin-section">
                    <h3>üìã Gestion des Missions</h3>
                    <button class="admin-btn" onclick="generateMissions()">G√©n√©rer Nouvelles Missions</button>
                    <button class="admin-btn" onclick="completeAllMissions()">Terminer Toutes les Missions</button>
                    <button class="admin-btn" onclick="clearAllMissions()">Vider Toutes les Missions</button>
                </div>
                <div class="admin-section">
                    <h3>‚úèÔ∏è Cr√©er Mission Personnalis√©e</h3>
                    <input type="text" class="admin-input" id="mission-destination" placeholder="Destination (ex: Berlin)">
                    <input type="number" class="admin-input" id="mission-distance" placeholder="Distance (km)">
                    <input type="number" class="admin-input" id="mission-reward" placeholder="R√©compense (‚Ç¨)">
                    <input type="number" class="admin-input" id="mission-fuel" placeholder="Carburant requis (L)">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="number" class="admin-input" id="mission-time" placeholder="Dur√©e" style="flex: 1;">
                        <select class="admin-input" id="mission-time-unit" style="width: auto; min-width: 100px;">
                            <option value="minutes">Minutes</option>
                            <option value="hours">Heures</option>
                        </select>
                    </div>
                    <label style="display: flex; align-items: center; margin: 10px 0;">
                        <input type="checkbox" id="mission-urgent" style="margin-right: 10px;"> Mission urgente (+50% r√©compense)
                    </label>
                    <button class="admin-btn" onclick="createCustomMission()">Cr√©er Mission</button>
                </div>
                <div class="admin-section">
                    <h3>üè≠ Gestion de l'Usine</h3>
                    <input type="number" class="admin-input" id="admin-factory-level" placeholder="Niveau">
                    <button class="admin-btn" onclick="setFactoryLevel()">D√©finir le Niveau</button>
                </div>
                <div class="admin-section">
                    <h3>‚≠ê R√©putation</h3>
                    <input type="number" class="admin-input" id="admin-reputation" placeholder="R√©putation">
                    <button class="admin-btn" onclick="setReputation()">D√©finir la R√©putation</button>
                </div>
                <div class="admin-section">
                    <h3>üéØ Templates de Missions Auto</h3>
                    <select class="admin-input" id="template-selector" onchange="loadTemplate()">
                        <option value="">Choisir un template √† modifier</option>
                    </select>
                    <input type="text" class="admin-input" id="template-destination" placeholder="Destination" readonly>
                    <input type="number" class="admin-input" id="template-distance" placeholder="Distance (km)">
                    <input type="number" class="admin-input" id="template-reward" placeholder="R√©compense de base (‚Ç¨)">
                    <input type="number" class="admin-input" id="template-fuel" placeholder="Carburant requis (L)">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="number" class="admin-input" id="template-time" placeholder="Dur√©e" style="flex: 1;">
                        <select class="admin-input" id="template-time-unit" style="width: auto; min-width: 100px;">
                            <option value="seconds">Secondes</option>
                            <option value="minutes">Minutes</option>
                            <option value="hours">Heures</option>
                        </select>
                    </div>
                    <button class="admin-btn" onclick="updateTemplate()">Mettre √† Jour Template</button>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // Syst√®me audio
        let audioContext;
        let soundEnabled = true;

        // Initialiser le contexte audio
        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.log('Audio non support√©');
                soundEnabled = false;
            }
        }

        // Fonction pour cr√©er des sons synth√©tiques
        function playSound(type) {
            if (!soundEnabled || !audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            switch(type) {
                case 'truck_departure': // D√©part camion - son grave moteur
                    oscillator.frequency.setValueAtTime(80, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(120, audioContext.currentTime + 0.3);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    oscillator.type = 'sawtooth';
                    break;
                    
                case 'truck_arrival': // Arriv√©e camion - son satisfaisant
                    oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(300, audioContext.currentTime + 0.2);
                    oscillator.frequency.exponentialRampToValueAtTime(250, audioContext.currentTime + 0.4);
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                    oscillator.type = 'triangle';
                    break;
                    
                case 'money_in': // Argent gagn√© - son de caisse
                    oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(600, audioContext.currentTime + 0.1);
                    oscillator.frequency.exponentialRampToValueAtTime(500, audioContext.currentTime + 0.2);
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    oscillator.type = 'sine';
                    break;
                    
                case 'money_out': // Argent d√©pens√© - son descendant
                    oscillator.frequency.setValueAtTime(300, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(150, audioContext.currentTime + 0.2);
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    oscillator.type = 'triangle';
                    break;
                    
                case 'upgrade': // Am√©lioration - son √©lectronique
                    oscillator.frequency.setValueAtTime(500, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(800, audioContext.currentTime + 0.1);
                    oscillator.frequency.exponentialRampToValueAtTime(600, audioContext.currentTime + 0.3);
                    gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                    oscillator.type = 'square';
                    break;
                    
                case 'notification': // Notification - son doux
                    oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(660, audioContext.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0.05, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    oscillator.type = 'sine';
                    break;
            }
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        // Fonction pour jouer un son de pi√®ces (argent)
        function playCoinsSound() {
            if (!soundEnabled || !audioContext) return;
            
            // Cr√©er plusieurs bips rapides pour simuler des pi√®ces
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(800 + (i * 200), audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.05, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    oscillator.type = 'sine';
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.1);
                }, i * 50);
            }
        }

        // √âtat du jeu
        let gameState = {
            money: 1000,
            fuel: 10,
            reputation: 100,
            trucks: [
                {
                    id: 1,
                    name: "Camion #1",
                    status: "idle", // idle, working, maintenance
                    condition: 100,
                    fuelConsumption: 2,
                    mission: null,
                    workStartTime: null
                }
            ],
            missions: [],
            factory: {
                level: 1,
                production: 1, // L par heure
                lastProduction: Date.now()
            },
            stats: {
                totalEarnings: 0,
                completedMissions: 0
            },
            lastSave: Date.now(),
            offlineTime: 0
        };

        // Donn√©es des missions avec unit√©s de temps plus lisibles
        const missionTemplates = [
            { destination: "Paris", distance: 100, baseReward: 200, fuelCost: 5, time: 1, timeUnit: "minutes" },
            { destination: "Lyon", distance: 150, baseReward: 300, fuelCost: 8, time: 1.5, timeUnit: "minutes" },
            { destination: "Marseille", distance: 200, baseReward: 400, fuelCost: 10, time: 2, timeUnit: "minutes" },
            { destination: "Bordeaux", distance: 180, baseReward: 350, fuelCost: 9, time: 1.7, timeUnit: "minutes" },
            { destination: "Toulouse", distance: 170, baseReward: 330, fuelCost: 8, time: 1.6, timeUnit: "minutes" },
            { destination: "Lille", distance: 80, baseReward: 180, fuelCost: 4, time: 50, timeUnit: "seconds" },
            { destination: "Strasbourg", distance: 140, baseReward: 280, fuelCost: 7, time: 1.3, timeUnit: "minutes" },
            { destination: "Nantes", distance: 130, baseReward: 260, fuelCost: 6, time: 1.2, timeUnit: "minutes" }
        ];

        // Boutique
        const shopItems = [
            {
                id: "truck",
                name: "Nouveau Camion",
                description: "Acheter un camion suppl√©mentaire pour augmenter vos revenus",
                price: 5000,
                type: "truck"
            },
            {
                id: "fuel_efficiency",
                name: "Am√©lioration Carburant",
                description: "R√©duit la consommation de carburant de tous les camions de 10%",
                price: 2000,
                type: "upgrade"
            },
            {
                id: "speed_upgrade",
                name: "Am√©lioration Vitesse",
                description: "R√©duit le temps de mission de tous les camions de 15%",
                price: 3000,
                type: "upgrade"
            },
            {
                id: "repair_kit",
                name: "Kit de R√©paration",
                description: "R√©pare imm√©diatement tous vos camions",
                price: 500,
                type: "consumable"
            }
        ];

        // Initialisation
        function init() {
            // Initialiser l'audio au premier clic (requis par les navigateurs)
            document.addEventListener('click', function initAudioOnFirstClick() {
                if (!audioContext) {
                    initAudio();
                    document.removeEventListener('click', initAudioOnFirstClick);
                }
            }, { once: true });

            loadGame();
            calculateOfflineProgress();
            updateUI();
            
            // S'assurer qu'il y a des missions au d√©marrage
            if (gameState.missions.length === 0) {
                generateMissions();
            }
            
            renderTrucks();
            renderMissions();
            renderShop();
            
            // Initialiser le s√©lecteur de templates
            populateTemplateSelector();
            
            // D√©marrer les timers
            setInterval(updateFuelProduction, 1000);
            setInterval(updateMissions, 1000);
            setInterval(updateTimers, 1000); // Nouveau timer pour mettre √† jour les affichages
            setInterval(saveGame, 30000); // Sauvegarde automatique toutes les 30 secondes
        }

        // Calcul du progr√®s hors ligne
        function calculateOfflineProgress() {
            const now = Date.now();
            const timeDiff = now - gameState.lastSave;
            gameState.offlineTime = Math.floor(timeDiff / 1000 / 60); // minutes
            
            if (timeDiff > 60000) { // Plus d'une minute hors ligne
                // Production de carburant hors ligne
                const hoursPassed = timeDiff / (1000 * 60 * 60);
                const fuelProduced = Math.floor(hoursPassed * gameState.factory.production);
                gameState.fuel += fuelProduced;
                
                // V√©rifier les missions termin√©es pendant l'absence
                let offlineEarnings = 0;
                let missionsCompleted = 0;
                
                gameState.trucks.forEach(truck => {
                    if (truck.status === 'working' && truck.mission && truck.workStartTime) {
                        const missionTimeElapsed = Math.floor((now - truck.workStartTime) / 1000);
                        if (missionTimeElapsed >= truck.mission.time) {
                            // Mission termin√©e pendant l'absence
                            offlineEarnings += truck.mission.reward;
                            gameState.money += truck.mission.reward;
                            gameState.stats.totalEarnings += truck.mission.reward;
                            gameState.stats.completedMissions++;
                            missionsCompleted++;
                            
                            // R√©initialiser le camion
                            truck.status = 'idle';
                            truck.condition -= Math.floor(Math.random() * 10) + 5;
                            truck.condition = Math.max(0, truck.condition);
                            truck.mission = null;
                            truck.workStartTime = null;
                        }
                    }
                });
                
                let message = `Vous √©tiez absent ${gameState.offlineTime}m.`;
                if (fuelProduced > 0) message += ` Carburant produit: ${fuelProduced}L.`;
                if (offlineEarnings > 0) message += ` Missions termin√©es: ${missionsCompleted} (+${offlineEarnings}‚Ç¨).`;
                
                showNotification(message);
            }
            
            gameState.lastSave = now;
        }

        // Navigation
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
        }

        // Mise √† jour de l'interface
        function updateUI() {
            document.getElementById('money').textContent = formatNumber(gameState.money) + '‚Ç¨';
            document.getElementById('fuel').textContent = formatNumber(gameState.fuel);
            document.getElementById('truck-count').textContent = gameState.trucks.length;
            document.getElementById('reputation').textContent = gameState.reputation;
            document.getElementById('total-earnings').textContent = formatNumber(gameState.stats.totalEarnings) + '‚Ç¨';
            document.getElementById('completed-missions').textContent = gameState.stats.completedMissions;
            document.getElementById('offline-time').textContent = gameState.offlineTime + 'm';
            
            // Usine
            document.getElementById('factory-level').textContent = gameState.factory.level;
            document.getElementById('factory-rate').textContent = gameState.factory.production;
            document.getElementById('factory-upgrade-cost').textContent = (gameState.factory.level * 500) + '‚Ç¨';
            
            // Mettre √† jour les livraisons en cours sur le tableau de bord
            renderActiveMissions();
        }

        // Afficher les livraisons en cours sur le tableau de bord
        function renderActiveMissions() {
            const container = document.getElementById('active-missions-container');
            if (!container) return;
            
            const activeTrucks = gameState.trucks.filter(truck => truck.status === 'working');
            
            if (activeTrucks.length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">Aucune livraison en cours</p>';
                return;
            }
            
            container.innerHTML = '';
            
            activeTrucks.forEach(truck => {
                if (!truck.mission || !truck.workStartTime) return;
                
                const timeElapsed = Math.floor((Date.now() - truck.workStartTime) / 1000);
                const timeLeft = Math.max(0, truck.mission.time - timeElapsed);
                const progress = Math.min(100, (timeElapsed / truck.mission.time) * 100);
                
                const missionDiv = document.createElement('div');
                missionDiv.className = 'mission-card';
                missionDiv.style.background = 'linear-gradient(145deg, #e8f5e8, #c8e6c9)';
                missionDiv.style.border = '2px solid #4CAF50';
                
                missionDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4>üöõ ${truck.name}</h4>
                            <p>üéØ Destination: ${truck.mission.destination}</p>
                            <p>üí∞ R√©compense: ${truck.mission.reward}‚Ç¨</p>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 20px; font-weight: bold; color: #4CAF50;">
                                ${Math.floor(timeLeft / 60)}m ${timeLeft % 60}s
                            </div>
                            <div style="font-size: 12px; color: #666;">restant</div>
                        </div>
                    </div>
                    <div class="progress-bar" style="margin-top: 10px;">
                        <div class="progress-fill" style="width: ${progress}%">${Math.floor(progress)}%</div>
                    </div>
                `;
                
                container.appendChild(missionDiv);
            });
        }

        // Production de carburant
        function updateFuelProduction() {
            const now = Date.now();
            const timeSinceLastProduction = now - gameState.factory.lastProduction;
            const productionInterval = 3600000 / gameState.factory.production; // ms par litre
            
            if (timeSinceLastProduction >= productionInterval) {
                gameState.fuel += 1;
                gameState.factory.lastProduction = now;
                playSound('money_in'); // Son de production
                updateUI();
            }
            
            // Barre de progression
            const progress = (timeSinceLastProduction / productionInterval) * 100;
            document.getElementById('fuel-progress').style.width = Math.min(progress, 100) + '%';
            document.getElementById('fuel-progress').textContent = Math.floor(Math.min(progress, 100)) + '%';
            
            // Timer
            const timeLeft = Math.max(0, productionInterval - timeSinceLastProduction);
            document.getElementById('fuel-timer').textContent = Math.ceil(timeLeft / 1000) + 's';
        }

        // G√©n√©ration de missions
        function generateMissions() {
            // Garder seulement les missions personnalis√©es
            gameState.missions = gameState.missions.filter(mission => mission.isCustom);
            
            // Ajouter 5 nouvelles missions automatiques
            addAutoMissions(5);
        }

        // Rendu des camions
        function renderTrucks() {
            const container = document.getElementById('trucks-container');
            container.innerHTML = '';
            
            gameState.trucks.forEach(truck => {
                const truckDiv = document.createElement('div');
                truckDiv.className = 'truck-card';
                truckDiv.id = `truck-${truck.id}`; // ID pour mise √† jour individuelle
                
                updateTruckDisplay(truckDiv, truck);
                container.appendChild(truckDiv);
            });
        }

        // Mettre √† jour l'affichage d'un camion sp√©cifique
        function updateTruckDisplay(truckDiv, truck) {
            let statusText = '';
            let statusClass = '';
            let actionButton = '';
            
            if (truck.status === 'idle') {
                statusText = 'Disponible';
                statusClass = 'status-idle';
                actionButton = '<button class="buy-btn" onclick="sendToMaintenance(' + truck.id + ')">Maintenance (100‚Ç¨)</button>';
            } else if (truck.status === 'working') {
                statusText = 'En Mission';
                statusClass = 'status-working';
                const timeElapsed = Math.floor((Date.now() - truck.workStartTime) / 1000);
                const timeLeft = Math.max(0, truck.mission.time - timeElapsed);
                actionButton = `<div style="color: #4CAF50; font-weight: bold;">Retour dans ${Math.floor(timeLeft / 60)}m ${timeLeft % 60}s</div>`;
            } else if (truck.status === 'maintenance') {
                statusText = 'En Maintenance';
                statusClass = 'status-maintenance';
                actionButton = '<button class="buy-btn" onclick="finishMaintenance(' + truck.id + ')">Terminer (Gratuit)</button>';
            }
            
            truckDiv.innerHTML = `
                <h3>${truck.name}</h3>
                <div class="truck-status ${statusClass}">${statusText}</div>
                <p>√âtat: ${truck.condition}%</p>
                <p>Consommation: ${truck.fuelConsumption}L/mission</p>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${truck.condition}%">${truck.condition}%</div>
                </div>
                ${actionButton}
            `;
        }

        // Mise √† jour des timers en temps r√©el
        function updateTimers() {
            // Mettre √† jour les camions en mission
            gameState.trucks.forEach(truck => {
                if (truck.status === 'working') {
                    const truckDiv = document.getElementById(`truck-${truck.id}`);
                    if (truckDiv) {
                        updateTruckDisplay(truckDiv, truck);
                    }
                }
            });
            
            // Mettre √† jour les missions actives sur le tableau de bord
            renderActiveMissions();
            
            // Mettre √† jour les boutons de missions toutes les secondes pour √™tre s√ªr
            updateMissionButtons();
        }

        // Fonction pour mettre √† jour uniquement les boutons des missions
        function updateMissionButtons() {
            const missionCards = document.querySelectorAll('#missions-container .mission-card');
            
            missionCards.forEach((card, index) => {
                if (index < gameState.missions.length) {
                    const mission = gameState.missions[index];
                    const button = card.querySelector('.buy-btn');
                    const availableTrucks = getIdleTrucks();
                    
                    if (button) {
                        let buttonText = 'Commencer la mission';
                        let buttonDisabled = false;
                        
                        if (availableTrucks.length === 0) {
                            buttonText = 'Aucun camion disponible';
                            buttonDisabled = true;
                        } else if (gameState.fuel < mission.fuelCost) {
                            buttonText = 'Pas assez de carburant';
                            buttonDisabled = true;
                        }
                        
                        button.textContent = buttonText;
                        button.disabled = buttonDisabled;
                    }
                }
            });
        }

        // Rendu des missions
        function renderMissions() {
            const container = document.getElementById('missions-container');
            container.innerHTML = '';
            
            gameState.missions.forEach(mission => {
                const missionDiv = document.createElement('div');
                missionDiv.className = 'mission-card';
                if (mission.urgency === 'urgent') {
                    missionDiv.style.background = 'linear-gradient(145deg, #ffebee, #ffcdd2)';
                    missionDiv.style.borderColor = '#f44336';
                }
                
                const availableTrucks = getIdleTrucks();
                
                let buttonText = 'Commencer la mission';
                let buttonDisabled = false;
                
                if (availableTrucks.length === 0) {
                    buttonText = 'Aucun camion disponible';
                    buttonDisabled = true;
                } else if (gameState.fuel < mission.fuelCost) {
                    buttonText = 'Pas assez de carburant';
                    buttonDisabled = true;
                }
                
                missionDiv.innerHTML = `
                    <h3>üéØ ${mission.destination} ${mission.urgency === 'urgent' ? '‚ö° URGENT' : ''} ${mission.isCustom ? '‚úèÔ∏è CUSTOM' : ''}</h3>
                    <p>üìè Distance: ${mission.distance} km</p>
                    <p>‚õΩ Carburant requis: ${mission.fuelCost} L</p>
                    <p>‚è±Ô∏è Dur√©e: ${Math.floor(mission.time / 60)}m ${mission.time % 60}s</p>
                    <div class="mission-reward">${mission.reward}‚Ç¨</div>
                    <button class="buy-btn" onclick="startMission(${mission.id})" ${buttonDisabled ? 'disabled' : ''}>
                        ${buttonText}
                    </button>
                `;
                
                container.appendChild(missionDiv);
            });
        }

        // Rendu de la boutique
        function renderShop() {
            const container = document.getElementById('shop-container');
            container.innerHTML = '';
            
            shopItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'shop-item';
                
                let actualPrice = item.price;
                if (item.id === 'truck') {
                    actualPrice = Math.floor(item.price * Math.pow(1.5, gameState.trucks.length - 1));
                }
                
                itemDiv.innerHTML = `
                    <h3>${item.name}</h3>
                    <p>${item.description}</p>
                    <span class="shop-price">${formatNumber(actualPrice)}‚Ç¨</span>
                    <button class="buy-btn" onclick="buyItem('${item.id}')" ${gameState.money < actualPrice ? 'disabled' : ''}>
                        ${gameState.money < actualPrice ? 'Pas assez d\'argent' : 'Acheter'}
                    </button>
                `;
                
                container.appendChild(itemDiv);
            });
        }

        // Logique du jeu
        function canStartMission(mission) {
            return getIdleTrucks().length > 0 && gameState.fuel >= mission.fuelCost;
        }

        function getIdleTrucks() {
            return gameState.trucks.filter(truck => truck.status === 'idle' && truck.condition > 0);
        }

        function startMission(missionId) {
            const mission = gameState.missions.find(m => m.id === missionId);
            const availableTrucks = getIdleTrucks();
            
            if (!mission) {
                showNotification('Mission introuvable !');
                return;
            }
            
            if (availableTrucks.length === 0) {
                showNotification('Aucun camion disponible !');
                return;
            }
            
            if (gameState.fuel < mission.fuelCost) {
                showNotification('Pas assez de carburant !');
                return;
            }
            
            const truck = availableTrucks[0];
            truck.status = 'working';
            truck.mission = mission;
            truck.workStartTime = Date.now();
            
            gameState.fuel -= mission.fuelCost;
            gameState.missions = gameState.missions.filter(m => m.id !== missionId);
            
            playSound('truck_departure'); // Son de d√©part
            showNotification(`${truck.name} est parti pour ${mission.destination} !`);
            updateUI();
            renderTrucks();
            renderMissions();
        }

        function updateMissions() {
            let missionsCompleted = false;
            
            gameState.trucks.forEach(truck => {
                if (truck.status === 'working') {
                    const timeElapsed = Math.floor((Date.now() - truck.workStartTime) / 1000);
                    if (timeElapsed >= truck.mission.time) {
                        // Mission termin√©e
                        gameState.money += truck.mission.reward;
                        gameState.stats.totalEarnings += truck.mission.reward;
                        gameState.stats.completedMissions++;
                        gameState.reputation += Math.floor(Math.random() * 5) + 1;
                        
                        // D√©gradation du camion
                        truck.condition -= Math.floor(Math.random() * 10) + 5;
                        truck.condition = Math.max(0, truck.condition);
                        
                        playSound('truck_arrival'); // Son d'arriv√©e
                        setTimeout(() => playCoinsSound(), 200); // Son d'argent apr√®s
                        showNotification(`${truck.name} a termin√© sa mission ! +${truck.mission.reward}‚Ç¨`);
                        
                        truck.status = 'idle';
                        truck.mission = null;
                        truck.workStartTime = null;
                        
                        missionsCompleted = true;
                    }
                }
            });
            
            if (missionsCompleted) {
                updateUI();
                renderTrucks();
                
                // IMPORTANT: Mettre √† jour les missions pour r√©activer les boutons
                setTimeout(() => {
                    renderMissions();
                }, 100); // Petit d√©lai pour s'assurer que l'√©tat est bien mis √† jour
                
                // G√©n√©rer de nouvelles missions automatiques si n√©cessaire
                const autoMissions = gameState.missions.filter(m => !m.isCustom);
                if (autoMissions.length < 3) {
                    addAutoMissions(5 - autoMissions.length);
                }
            }
        }

        // Ajouter des missions automatiques sans supprimer les personnalis√©es
        function addAutoMissions(count) {
            for (let i = 0; i < count; i++) {
                const template = missionTemplates[Math.floor(Math.random() * missionTemplates.length)];
                
                // Convertir le temps en secondes selon l'unit√© du template
                let timeInSeconds;
                switch(template.timeUnit) {
                    case 'minutes':
                        timeInSeconds = template.time * 60;
                        break;
                    case 'hours':
                        timeInSeconds = template.time * 3600;
                        break;
                    case 'seconds':
                    default:
                        timeInSeconds = template.time;
                }
                
                const mission = {
                    id: Date.now() + i * 1000, // ID entier unique
                    ...template,
                    time: timeInSeconds, // Utiliser le temps converti
                    reward: Math.floor(template.baseReward * (0.8 + Math.random() * 0.4)),
                    urgency: Math.random() > 0.7 ? 'urgent' : 'normal',
                    isCustom: false
                };
                if (mission.urgency === 'urgent') {
                    mission.reward = Math.floor(mission.reward * 1.5);
                }
                gameState.missions.push(mission);
            }
            renderMissions();
        }

        function sendToMaintenance(truckId) {
            const truck = gameState.trucks.find(t => t.id === truckId);
            if (truck && truck.status === 'idle' && gameState.money >= 100) {
                gameState.money -= 100;
                truck.status = 'maintenance';
                playSound('money_out'); // Son de d√©pense
                updateUI();
                renderTrucks();
                showNotification(`${truck.name} est en maintenance !`);
            }
        }

        function finishMaintenance(truckId) {
            const truck = gameState.trucks.find(t => t.id === truckId);
            if (truck && truck.status === 'maintenance') {
                truck.condition = 100;
                truck.status = 'idle';
                playSound('upgrade'); // Son d'am√©lioration
                updateUI();
                renderTrucks();
                
                // Mettre √† jour les boutons de missions car un nouveau camion est disponible
                setTimeout(() => {
                    updateMissionButtons();
                }, 100);
                
                showNotification(`${truck.name} est comme neuf !`);
            }
        }

        function upgradeFactory() {
            const cost = gameState.factory.level * 500;
            if (gameState.money >= cost) {
                gameState.money -= cost;
                gameState.factory.level++;
                gameState.factory.production++;
                playSound('money_out'); // Son de d√©pense
                setTimeout(() => playSound('upgrade'), 300); // Son d'am√©lioration apr√®s
                updateUI();
                showNotification(`Usine am√©lior√©e ! Production: ${gameState.factory.production}L/h`);
            }
        }

        function buyItem(itemId) {
            const item = shopItems.find(i => i.id === itemId);
            if (!item) return;
            
            let actualPrice = item.price;
            if (item.id === 'truck') {
                actualPrice = Math.floor(item.price * Math.pow(1.5, gameState.trucks.length - 1));
            }
            
            if (gameState.money >= actualPrice) {
                gameState.money -= actualPrice;
                playSound('money_out'); // Son de d√©pense
                
                switch (item.id) {
                    case 'truck':
                        const newTruck = {
                            id: Date.now(),
                            name: `Camion #${gameState.trucks.length + 1}`,
                            status: 'idle',
                            condition: 100,
                            fuelConsumption: 2,
                            mission: null,
                            workStartTime: null
                        };
                        gameState.trucks.push(newTruck);
                        setTimeout(() => playSound('upgrade'), 300); // Son d'am√©lioration apr√®s
                        showNotification('Nouveau camion achet√© !');
                        renderTrucks();
                        break;
                        
                    case 'fuel_efficiency':
                        gameState.trucks.forEach(truck => {
                            truck.fuelConsumption = Math.max(1, truck.fuelConsumption - 0.2);
                        });
                        setTimeout(() => playSound('upgrade'), 300);
                        showNotification('Efficacit√© carburant am√©lior√©e !');
                        renderTrucks();
                        break;
                        
                    case 'speed_upgrade':
                        // Appliqu√© lors du calcul des missions
                        setTimeout(() => playSound('upgrade'), 300);
                        showNotification('Vitesse des camions am√©lior√©e !');
                        break;
                        
                    case 'repair_kit':
                        gameState.trucks.forEach(truck => {
                            truck.condition = 100;
                            if (truck.status === 'maintenance') {
                                truck.status = 'idle';
                            }
                        });
                        setTimeout(() => playSound('upgrade'), 300);
                        showNotification('Tous les camions r√©par√©s !');
                        renderTrucks();
                        break;
                }
                
                updateUI();
                renderShop();
            }
        }

        // Fonctions admin
        function setMoney() {
            const amount = parseInt(document.getElementById('admin-money').value);
            if (!isNaN(amount)) {
                gameState.money = amount;
                playSound('money_in');
                updateUI();
                showNotification('Argent modifi√© !');
            }
        }

        function addMoney() {
            const amount = parseInt(document.getElementById('admin-money').value);
            if (!isNaN(amount)) {
                gameState.money += amount;
                playSound('money_in');
                updateUI();
                showNotification('Argent ajout√© !');
            }
        }

        function setFuel() {
            const amount = parseInt(document.getElementById('admin-fuel').value);
            if (!isNaN(amount)) {
                gameState.fuel = amount;
                playSound('upgrade');
                updateUI();
                showNotification('Carburant modifi√© !');
            }
        }

        function addFuel() {
            const amount = parseInt(document.getElementById('admin-fuel').value);
            if (!isNaN(amount)) {
                gameState.fuel += amount;
                playSound('upgrade');
                updateUI();
                showNotification('Carburant ajout√© !');
            }
        }

        function addTruck() {
            const newTruck = {
                id: Date.now(),
                name: `Camion #${gameState.trucks.length + 1}`,
                status: 'idle',
                condition: 100,
                fuelConsumption: 2,
                mission: null,
                workStartTime: null
            };
            gameState.trucks.push(newTruck);
            playSound('upgrade');
            updateUI();
            renderTrucks();
            showNotification('Camion ajout√© !');
        }

        function repairAllTrucks() {
            gameState.trucks.forEach(truck => {
                truck.condition = 100;
                if (truck.status === 'maintenance') {
                    truck.status = 'idle';
                }
            });
            playSound('upgrade');
            renderTrucks();
            showNotification('Tous les camions r√©par√©s !');
        }

        function completeAllMissions() {
            gameState.trucks.forEach(truck => {
                if (truck.status === 'working') {
                    gameState.money += truck.mission.reward;
                    gameState.stats.totalEarnings += truck.mission.reward;
                    gameState.stats.completedMissions++;
                    truck.status = 'idle';
                    truck.mission = null;
                    truck.workStartTime = null;
                }
            });
            playSound('money_in');
            updateUI();
            renderTrucks();
            
            // Mettre √† jour les missions pour r√©activer les boutons
            setTimeout(() => {
                renderMissions();
            }, 100);
            
            showNotification('Toutes les missions termin√©es !');
        }

        function clearAllMissions() {
            gameState.missions = [];
            playSound('notification');
            renderMissions();
            showNotification('Toutes les missions supprim√©es !');
        }

        function setFactoryLevel() {
            const level = parseInt(document.getElementById('admin-factory-level').value);
            if (!isNaN(level) && level > 0) {
                gameState.factory.level = level;
                gameState.factory.production = level;
                playSound('upgrade');
                updateUI();
                showNotification('Niveau d\'usine modifi√© !');
            }
        }

        function setReputation() {
            const rep = parseInt(document.getElementById('admin-reputation').value);
            if (!isNaN(rep)) {
                gameState.reputation = Math.max(0, rep);
                playSound('upgrade');
                updateUI();
                showNotification('R√©putation modifi√©e !');
            }
        }

        // Fonctions pour g√©rer les templates de missions
        function populateTemplateSelector() {
            const selector = document.getElementById('template-selector');
            if (!selector) return;
            
            // Vider le s√©lecteur
            selector.innerHTML = '<option value="">Choisir un template √† modifier</option>';
            
            // Ajouter chaque template
            missionTemplates.forEach((template, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = template.destination;
                selector.appendChild(option);
            });
        }
        
        function loadTemplate() {
            const selector = document.getElementById('template-selector');
            const index = parseInt(selector.value);
            
            if (isNaN(index) || index < 0 || index >= missionTemplates.length) {
                // Vider les champs si aucun template s√©lectionn√©
                document.getElementById('template-destination').value = '';
                document.getElementById('template-distance').value = '';
                document.getElementById('template-reward').value = '';
                document.getElementById('template-fuel').value = '';
                document.getElementById('template-time').value = '';
                document.getElementById('template-time-unit').value = 'minutes';
                return;
            }
            
            const template = missionTemplates[index];
            document.getElementById('template-destination').value = template.destination;
            document.getElementById('template-distance').value = template.distance;
            document.getElementById('template-reward').value = template.baseReward;
            document.getElementById('template-fuel').value = template.fuelCost;
            document.getElementById('template-time').value = template.time;
            document.getElementById('template-time-unit').value = template.timeUnit || 'minutes';
        }
        
        function updateTemplate() {
            const selector = document.getElementById('template-selector');
            const index = parseInt(selector.value);
            
            if (isNaN(index) || index < 0 || index >= missionTemplates.length) {
                showNotification('Veuillez s√©lectionner un template √† modifier !');
                return;
            }
            
            const distance = parseInt(document.getElementById('template-distance').value);
            const reward = parseInt(document.getElementById('template-reward').value);
            const fuel = parseInt(document.getElementById('template-fuel').value);
            const time = parseFloat(document.getElementById('template-time').value);
            const timeUnit = document.getElementById('template-time-unit').value;
            
            if (isNaN(distance) || isNaN(reward) || isNaN(fuel) || isNaN(time)) {
                showNotification('Veuillez remplir tous les champs num√©riques !');
                return;
            }
            
            // Mettre √† jour le template
            missionTemplates[index].distance = distance;
            missionTemplates[index].baseReward = reward;
            missionTemplates[index].fuelCost = fuel;
            missionTemplates[index].time = time;
            missionTemplates[index].timeUnit = timeUnit;
            
            playSound('upgrade');
            showNotification(`Template ${missionTemplates[index].destination} mis √† jour !`);
            
            // R√©g√©n√©rer les missions pour appliquer les changements
            generateMissions();
        }

        function createCustomMission() {
            const destination = document.getElementById('mission-destination').value;
            const distance = parseInt(document.getElementById('mission-distance').value);
            const reward = parseInt(document.getElementById('mission-reward').value);
            const fuelCost = parseInt(document.getElementById('mission-fuel').value);
            const timeValue = parseInt(document.getElementById('mission-time').value);
            const timeUnit = document.getElementById('mission-time-unit').value;
            const isUrgent = document.getElementById('mission-urgent').checked;

            if (!destination || isNaN(distance) || isNaN(reward) || isNaN(fuelCost) || isNaN(timeValue)) {
                showNotification('Veuillez remplir tous les champs !');
                return;
            }

            // Convertir le temps en secondes selon l'unit√© choisie
            let timeInSeconds;
            switch(timeUnit) {
                case 'minutes':
                    timeInSeconds = timeValue * 60;
                    break;
                case 'hours':
                    timeInSeconds = timeValue * 3600;
                    break;
                default:
                    timeInSeconds = timeValue;
            }

            const mission = {
                id: Date.now() + Math.floor(Math.random() * 10000), // ID entier unique
                destination: destination,
                distance: distance,
                baseReward: reward,
                reward: isUrgent ? Math.floor(reward * 1.5) : reward,
                fuelCost: fuelCost,
                time: timeInSeconds,
                urgency: isUrgent ? 'urgent' : 'normal',
                isCustom: true // Marquer comme mission personnalis√©e
            };

            gameState.missions.push(mission);
            playSound('upgrade');
            renderMissions();
            
            // Vider les champs
            document.getElementById('mission-destination').value = '';
            document.getElementById('mission-distance').value = '';
            document.getElementById('mission-reward').value = '';
            document.getElementById('mission-fuel').value = '';
            document.getElementById('mission-time').value = '';
            document.getElementById('mission-urgent').checked = false;
            
            showNotification(`Mission vers ${destination} cr√©√©e !`);
        }

        // Sauvegarde et chargement
        function saveGame() {
            gameState.lastSave = Date.now();
            try {
                localStorage.setItem('truckManagerSave', JSON.stringify(gameState));
                showNotification('Jeu sauvegard√© !');
            } catch (e) {
                showNotification('Sauvegarde impossible (localStorage non disponible)');
                console.log('LocalStorage not available:', e);
            }
        }

        function loadGame() {
            try {
                const saved = localStorage.getItem('truckManagerSave');
                if (saved) {
                    const loadedState = JSON.parse(saved);
                    gameState = {...gameState, ...loadedState};
                    
                    // R√©trocompatibilit√© : marquer les missions sans flag comme missions automatiques
                    gameState.missions.forEach(mission => {
                        if (mission.isCustom === undefined) {
                            mission.isCustom = false;
                        }
                    });
                    
                    showNotification('Jeu charg√© !');
                }
            } catch (e) {
                console.log('Could not load game:', e);
            }
        }

        function resetGame() {
            if (confirm('√ätes-vous s√ªr de vouloir r√©initialiser le jeu ? Toutes les donn√©es seront perdues !')) {
                gameState = {
                    money: 1000,
                    fuel: 10,
                    reputation: 100,
                    trucks: [{
                        id: 1,
                        name: "Camion #1",
                        status: "idle",
                        condition: 100,
                        fuelConsumption: 2,
                        mission: null,
                        workStartTime: null
                    }],
                    missions: [],
                    factory: {
                        level: 1,
                        production: 1,
                        lastProduction: Date.now()
                    },
                    stats: {
                        totalEarnings: 0,
                        completedMissions: 0
                    },
                    lastSave: Date.now(),
                    offlineTime: 0
                };
                
                updateUI();
                generateMissions();
                renderTrucks();
                renderMissions();
                renderShop();
                showNotification('Jeu r√©initialis√© !');
            }
        }

        function exportSave() {
            const saveData = JSON.stringify(gameState, null, 2);
            const blob = new Blob([saveData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `truck-manager-save-${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('Sauvegarde export√©e !');
        }

        function importSave(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedState = JSON.parse(e.target.result);
                    gameState = {...gameState, ...importedState};
                    updateUI();
                    renderTrucks();
                    renderMissions();
                    renderShop();
                    showNotification('Sauvegarde import√©e avec succ√®s !');
                } catch (error) {
                    showNotification('Erreur lors de l\'importation !');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
        }

        // Utilitaires
        function formatNumber(num) {
            return new Intl.NumberFormat('fr-FR').format(num);
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            const button = document.getElementById('sound-toggle');
            if (soundEnabled) {
                button.textContent = 'üîä Son ON';
                button.style.background = '#4CAF50';
                if (!audioContext) initAudio();
            } else {
                button.textContent = 'üîá Son OFF';
                button.style.background = '#F44336';
            }
        }

        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            
            playSound('notification'); // Son de notification
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // D√©marrer le jeu
        init();
    </script>
</body>
</html>